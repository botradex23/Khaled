<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binance API Connection Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      color: #1d4ed8;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    .card {
      background-color: #f8fafc;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
    }
    .results {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .error {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      margin-right: 8px;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    pre {
      background-color: #1e293b;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 300px;
    }
    .test-group {
      margin-bottom: 30px;
    }
    .flex {
      display: flex;
      gap: 10px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 8px;
    }
    .pending {
      background-color: #e0f2fe;
      color: #0369a1;
    }
    .passed {
      background-color: #d1fae5;
      color: #065f46;
    }
    .failed {
      background-color: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Binance API Connection Test</h1>
    
    <div class="card">
      <h2>1. Server Status</h2>
      <p>Check if the Node.js and Python API servers are running</p>
      <button onclick="checkServerStatus()">Check Server Status</button>
      <div id="server-status-result" class="results"></div>
    </div>
    
    <div class="card">
      <h2>2. Binance API Connection</h2>
      <p>Test basic connectivity to Binance API</p>
      <button onclick="testBinanceConnection()">Test Connection</button>
      <div id="binance-connection-result" class="results"></div>
    </div>
    
    <div class="card">
      <h2>3. Proxy Status</h2>
      <p>Check if proxies are working correctly</p>
      <button onclick="checkProxyStatus()">Check Proxy Status</button>
      <div id="proxy-status-result" class="results"></div>
    </div>
    
    <div class="card">
      <h2>4. Ticker Price</h2>
      <p>Get current price for a cryptocurrency</p>
      <div class="flex">
        <input type="text" id="symbol-input" value="BTCUSDT" placeholder="Symbol (e.g. BTCUSDT)">
        <button onclick="getTickerPrice()">Get Price</button>
      </div>
      <div id="ticker-result" class="results"></div>
    </div>
    
    <div class="card">
      <h2>5. Run All Tests</h2>
      <p>Run all connectivity tests at once</p>
      <button onclick="runAllTests()">Run All Tests</button>
      <div id="all-tests-summary"></div>
      <div id="all-tests-result" class="results"></div>
    </div>
  </div>

  <script>
    // Configuration
    const API_SERVER = 'http://localhost:5000';
    const PYTHON_SERVER = 'http://localhost:5001';
    
    // Helper for displaying results
    function displayResult(elementId, success, message, data = null) {
      const element = document.getElementById(elementId);
      element.className = 'results ' + (success ? 'success' : 'error');
      
      let content = `<p><strong>${success ? '‚úÖ Success' : '‚ùå Error'}:</strong> ${message}</p>`;
      
      if (data) {
        content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
      
      element.innerHTML = content;
    }
    
    // Helper for making requests
    async function makeRequest(url) {
      try {
        const response = await fetch(url);
        return await response.json();
      } catch (error) {
        console.error('Request error:', error);
        return { error: error.message };
      }
    }
    
    // 1. Check Server Status
    async function checkServerStatus() {
      const statusElement = document.getElementById('server-status-result');
      statusElement.innerHTML = 'Checking server status...';
      
      try {
        // Check Node.js server
        const nodeResponse = await fetch(`${API_SERVER}/api/status`);
        const nodeData = await nodeResponse.json();
        
        // Check Python server
        const pythonResponse = await fetch(`${PYTHON_SERVER}/ping`);
        const pythonData = await pythonResponse.json();
        
        const allRunning = nodeData.status === 'online' && pythonData.success;
        
        displayResult(
          'server-status-result',
          allRunning,
          allRunning ? 'All servers are running' : 'Some servers are not running',
          {
            nodeServer: nodeData,
            pythonServer: pythonData
          }
        );
        
        return allRunning;
      } catch (error) {
        displayResult(
          'server-status-result',
          false,
          'Failed to connect to servers: ' + error.message
        );
        return false;
      }
    }
    
    // 2. Test Binance API Connection
    async function testBinanceConnection() {
      const resultElement = document.getElementById('binance-connection-result');
      resultElement.innerHTML = 'Testing Binance API connection...';
      
      try {
        const data = await makeRequest(`${PYTHON_SERVER}/ping`);
        
        const success = data.success === true;
        
        displayResult(
          'binance-connection-result',
          success,
          success ? 'Successfully connected to Binance API' : 'Failed to connect to Binance API',
          data
        );
        
        return success;
      } catch (error) {
        displayResult(
          'binance-connection-result',
          false,
          'Error testing Binance connection: ' + error.message
        );
        return false;
      }
    }
    
    // 3. Check Proxy Status
    async function checkProxyStatus() {
      const resultElement = document.getElementById('proxy-status-result');
      resultElement.innerHTML = 'Checking proxy status...';
      
      try {
        const data = await makeRequest(`${PYTHON_SERVER}/status`);
        
        const success = data.proxy && data.proxy.working;
        
        displayResult(
          'proxy-status-result',
          success,
          success ? `Working proxy found: ${data.proxy.current}` : 'No working proxy found',
          data
        );
        
        return success;
      } catch (error) {
        displayResult(
          'proxy-status-result',
          false,
          'Error checking proxy status: ' + error.message
        );
        return false;
      }
    }
    
    // 4. Get Ticker Price
    async function getTickerPrice() {
      const resultElement = document.getElementById('ticker-result');
      const symbolInput = document.getElementById('symbol-input');
      const symbol = symbolInput.value.trim().toUpperCase() || 'BTCUSDT';
      
      resultElement.innerHTML = `Getting price for ${symbol}...`;
      
      try {
        const data = await makeRequest(`${PYTHON_SERVER}/ticker/${symbol}`);
        
        const success = data.symbol === symbol && data.price;
        
        if (success) {
          const price = parseFloat(data.price);
          displayResult(
            'ticker-result',
            true,
            `Current ${symbol} price: $${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
            data
          );
        } else {
          displayResult(
            'ticker-result',
            false,
            `Failed to get price for ${symbol}`,
            data
          );
        }
        
        return success;
      } catch (error) {
        displayResult(
          'ticker-result',
          false,
          'Error getting ticker price: ' + error.message
        );
        return false;
      }
    }
    
    // 5. Run All Tests
    async function runAllTests() {
      const summaryElement = document.getElementById('all-tests-summary');
      const resultElement = document.getElementById('all-tests-result');
      
      summaryElement.innerHTML = `
        <div>
          <p>Server Status: <span class="status-badge pending">Pending</span></p>
          <p>Binance Connection: <span class="status-badge pending">Pending</span></p>
          <p>Proxy Status: <span class="status-badge pending">Pending</span></p>
          <p>Ticker Price: <span class="status-badge pending">Pending</span></p>
        </div>
      `;
      
      resultElement.innerHTML = 'Running all tests...';
      resultElement.className = 'results';
      
      // Update status badge
      function updateStatus(index, status) {
        const badges = summaryElement.querySelectorAll('.status-badge');
        badges[index].className = `status-badge ${status}`;
        badges[index].innerText = status.charAt(0).toUpperCase() + status.slice(1);
      }
      
      // Run server status test
      try {
        const serverStatus = await checkServerStatus();
        updateStatus(0, serverStatus ? 'passed' : 'failed');
      } catch (error) {
        updateStatus(0, 'failed');
      }
      
      // Run Binance connection test
      try {
        const binanceConnection = await testBinanceConnection();
        updateStatus(1, binanceConnection ? 'passed' : 'failed');
      } catch (error) {
        updateStatus(1, 'failed');
      }
      
      // Run proxy status test
      try {
        const proxyStatus = await checkProxyStatus();
        updateStatus(2, proxyStatus ? 'passed' : 'failed');
      } catch (error) {
        updateStatus(2, 'failed');
      }
      
      // Run ticker price test
      try {
        const tickerPrice = await getTickerPrice();
        updateStatus(3, tickerPrice ? 'passed' : 'failed');
      } catch (error) {
        updateStatus(3, 'failed');
      }
      
      // Calculate overall status
      const badges = summaryElement.querySelectorAll('.status-badge');
      const passedCount = Array.from(badges).filter(badge => badge.classList.contains('passed')).length;
      const totalCount = badges.length;
      
      if (passedCount === totalCount) {
        resultElement.className = 'results success';
        resultElement.innerHTML = `<p><strong>‚úÖ All tests passed!</strong> Your Binance API connection is working correctly.</p>`;
      } else {
        resultElement.className = 'results error';
        resultElement.innerHTML = `<p><strong>‚ùå Some tests failed.</strong> ${passedCount} out of ${totalCount} tests passed. Check the individual test results for more details.</p>`;
      }
    }
  </script>
</body>
</html>